cmake_minimum_required(VERSION 3.14)
project(photon VERSION 1.0 LANGUAGES C)
set(CMAKE_C_STANDARD 23)
set(CMAKE_C_STANDARD_REQUIRED ON)
set(MACOS CMAKE_SYSTEM_NAME STREQUAL "Darwin")
include(FetchContent)

# ======================== CONFIGURATION
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE Release)
endif()
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    add_compile_definitions(DEBUG)
endif()

# ======================== DEPS
# === SDL 3
FetchContent_Declare(
    SDL
    GIT_REPOSITORY https://github.com/libsdl-org/SDL.git
    GIT_TAG release-3.2.0
)
FetchContent_MakeAvailable(SDL)

if (MACOS)
    # === Metal bindings
    # FetchContent_Declare(
    #     cmt
    #     GIT_REPOSITORY https://github.com/recp/cmt.git
    #     GIT_TAG fa15eda
    # )
    # FetchContent_MakeAvailable(cmt)
    add_subdirectory(/Users/tomtar/dev/projects/cmt ${CMAKE_BINARY_DIR}/cmt)
else()
    # === Vulkan
    find_package(Vulkan REQUIRED)
    if (Vulkan_FOUND)
        message(STATUS "Found Vulkan: ${Vulkan_LIBRARY}")
    else()
        message(FATAL_ERROR "Vulkan SDK not found. Please ensure VULKAN_SDK is set correctly.")
    endif()
endif()

# ========================= SOURCE
file(GLOB PHOTON_PUBLIC_HEADERS include/**.h)
file(GLOB PHOTON_PRIVATE_SOURCES src/**.c)
add_library(${PROJECT_NAME} STATIC
    ${PHOTON_PRIVATE_SOURCES}
    ${PHOTON_PUBLIC_HEADERS}
)
target_include_directories(${PROJECT_NAME} PRIVATE include)

target_link_libraries(${PROJECT_NAME} PRIVATE SDL3::SDL3)
target_include_directories(${PROJECT_NAME} PRIVATE ${SDL_SOURCE_DIR}/include)
if (MACOS)
    target_link_libraries(${PROJECT_NAME} PRIVATE cmt_lib)
    target_include_directories(${PROJECT_NAME} PRIVATE ${cmt_SOURCE_DIR}/include)
else()
    target_link_libraries(${PROJECT_NAME} PRIVATE Vulkan::Vulkan)
    target_include_directories(${PROJECT_NAME} PRIVATE ${Vulkan_INCLUDE_DIRS})
endif()

# ======================== EXAMPLES
file(GLOB EXAMPLE_SOURCES examples/*.c)
foreach(example_file ${EXAMPLE_SOURCES})
    get_filename_component(example_name ${example_file} NAME_WE)
    add_executable(${example_name} ${example_file})
    target_link_libraries(${example_name} PRIVATE ${PROJECT_NAME})
    target_include_directories(${example_name} PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}/include
    )
endforeach()
